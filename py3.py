import numpy as np
import re

# Parse the coordinate data from the provided text
def parse_coordinates(data_text):
    """
    Parses comma-separated coordinate data with a header.
    Each line is expected to be in 'Index,X,Y' format.
    """
    coordinates = []
    lines = data_text.strip().split('\n')
    # Skip the header line
    for line in lines[1:]:
        parts = line.strip().split(',')
        # Expects at least 3 parts (Index, X, Y)
        if len(parts) >= 3:
            try:
                # Use parts[1] for X and parts[2] for Y
                x = float(parts[1])
                y = float(parts[2])
                coordinates.append((x, y))
            except (ValueError, IndexError):
                # Ignore lines that cannot be properly parsed
                continue
    return coordinates

# Process coordinates with FFT filtering
def process_coordinates(coordinates, cutoff_freq=0.1):
    """
    Applies a low-pass filter to the coordinates using FFT.
    This helps to smooth the shape defined by the points.
    """
    # Convert to complex signal (x + j*y)
    x = np.array([p[0] for p in coordinates])
    y = np.array([p[1] for p in coordinates])
    z = x + 1j * y
    
    # Apply Fast Fourier Transform
    Z = np.fft.fft(z)
    freqs = np.fft.fftfreq(len(z))
    
    # Create a low-pass filter mask to remove high-frequency noise
    mask = np.abs(freqs) <= cutoff_freq
    Z_filtered = Z * mask
    
    # Apply Inverse FFT to get the filtered signal
    z_filtered = np.fft.ifft(Z_filtered)
    x_filtered = np.real(z_filtered)
    y_filtered = np.imag(z_filtered)
    
    return x_filtered, y_filtered

# Scale coordinates for a 12-bit DAC (Digital-to-Analog Converter)
def scale_for_dac(x, y):
    """
    Scales the x and y coordinates to fit within a 12-bit range (0-4095).
    This is necessary for outputting the analog signal on hardware like an STM32.
    """
    # Find min/max values for scaling to maintain aspect ratio
    x_min, x_max = np.min(x), np.max(x)
    y_min, y_max = np.min(y), np.max(y)
    
    # Scale to 12-bit unsigned integer range [0, 4095]
    x_dac = np.round((x - x_min) / (x_max - x_min) * 4095).astype(np.uint16)
    y_dac = np.round((y - y_min) / (y_max - y_min) * 4095).astype(np.uint16)
    
    return x_dac, y_dac

# Generate a C header file for an STM32 project
def generate_stm32_header(x_dac, y_dac, filename="arrow_data.h"):
    """
    Generates a .h file containing the scaled coordinate data as C arrays.
    """
    with open(filename, 'w') as f:
        f.write("// Generated by Python script\n")
        f.write("#ifndef ARROW_DATA_H\n")
        f.write("#define ARROW_DATA_H\n\n")
        f.write("#include <stdint.h>\n\n")
        f.write(f"#define ARROW_POINTS {len(x_dac)}\n\n")
        
        # Write X coordinates array
        f.write("const uint16_t arrow_x[ARROW_POINTS] = {\n    ")
        # Format with 12 values per line for readability
        f.write(", ".join(map(str, x_dac)))
        f.write("\n};\n\n")
        
        # Write Y coordinates array
        f.write("const uint16_t arrow_y[ARROW_POINTS] = {\n    ")
        # Format with 12 values per line for readability
        f.write(", ".join(map(str, y_dac)))
        f.write("\n};\n\n#endif // ARROW_DATA_H\n")

# Main processing block
# The data from 'drawing_coordinates.csv' is placed directly into this string.
data_text = """Index,X,Y
0,75.0,1331.0
1,75.0,1379.1067871141101
2,75.02649062271242,1427.2119249816994
3,80.99340319435063,1474.947225554805
4,88.14985165568318,1522.5137771051996
5,101.61975204763404,1568.6962927347454
6,108.74616812480454,1616.2594385700882
7,109.0,1664.3478144843739
8,115.7037192255622,1711.968360403855
9,116.0,1760.0536573700547
10,116.0,1808.160444484165
11,128.3563858346237,1854.623578466303
12,135.58685229935952,1902.166987195608
13,142.6649242317642,1949.750205556131
14,149.61389907703776,1997.352450813973
15,161.8764273486537,2043.8514240565676
16,175.26645081996026,2090.056402811292
17,193.12136155482298,2134.691267731575
18,218.804372869402,2175.149104099146
19,259.175317942802,2198.951701599976
20,291.15900086706097,2177.425220905574
21,322.6500215130464,2141.3499784869537
22,351.630219184035,2103.2281856835025
23,378.5225871808148,2063.341925913807
24,396.7192201156533,2019.498264188357
25,409.8136998036055,1973.210172101924
26,419.83198798566116,1926.270937810561
27,426.2994761893999,1878.6041904848005
28,432.8002452718663,1830.9411752786314
29,443.2613866833776,1784.1038170855625
30,453.5414095376118,1737.221964533178
31,460.55408838005843,1689.629108251028
32,467.0050808524502,1641.9593531803987
33,470.0,1594.0390229887512
34,473.4731442641138,1546.1841536175054
35,480.48639007898424,1498.5913808982489
36,484.0,1450.7448104710268
37,487.5156011584494,1402.8930206277755
38,491.0,1355.038967585346
39,494.5454618572879,1307.194756101067
40,494.36786464551795,1308.387194522951
41,487.35703615363707,1355.9803235179172
42,480.41489516953675,1403.5835759803194
43,477.0,1451.4426703359923
44,470.45545699731895,1498.6610400866161
45,460.55229140192336,1545.6414303868112
46,457.0,1593.4905589748369
47,450.3927430950948,1640.6534522453894
48,431.0629314188094,1684.1266596973635
49,404.60465217635766,1724.3040466951607
50,374.84506110913384,1761.7505120654127
51,335.1622817498343,1784.8056176117268
52,287.3661290866603,1789.0
53,239.25934197255037,1789.0
54,191.36029844258215,1786.13587685621
55,145.2451752753129,1774.0669932081184
56,132.07513732230564,1761.0
57,180.00208090797082,1763.4794701324124
58,227.60533337037322,1765.5783888834872
59,275.3800359795573,1761.0
60,323.35410053413136,1758.9122424850045
61,368.21383452140583,1745.2929910585522
62,408.0872944948655,1718.381537771674
63,444.2819100324956,1687.8729174524171
64,467.4358507957033,1646.3137816774033
65,478.66252755378883,1599.5998110597338
66,484.0,1551.88016709575
67,482.2356144523818,1503.9013562449038
68,477.0,1456.1743242100688
69,475.2780633516241,1408.1924344111367
70,471.698723042697,1360.5942881418914
71,480.3935687261435,1313.3649072246508
72,501.1196326164665,1275.524220243432
73,548.7185342138358,1271.4474412658903
74,596.3050962348315,1278.5028265342462
75,644.0131565969505,1284.0
76,692.0417962580728,1285.255224532259
77,739.4590569619643,1292.7588916139061
78,785.8731295769101,1305.1725937667738
79,833.4588654335553,1312.2335845423934
80,880.5206740182495,1321.1336141742706
81,921.6139080708642,1342.2096553430688
82,929.482015284148,1389.5568366819552
83,947.9846257126518,1433.9631017103643
84,954.9363725834353,1481.563697714985
85,955.0960895931644,1529.658900067413
86,962.0,1577.264925510146
87,962.0536406939219,1625.3678219011792
88,968.9957816780222,1672.9710743635812
89,975.0,1720.6961245480088
90,975.0,1768.8029116621192
91,975.0,1816.9096987762287
92,975.1497398610773,1865.0053962100899
93,982.0,1912.6048555223824
94,981.7529981690786,1960.6937268406036
95,975.0,2008.3106984080632
96,974.8241825594731,2056.4065395242146
97,969.0,2104.150726146493
98,969.2800100581104,2152.2400804648837
99,973.0309648858436,2197.706739451083
100,925.4208764830346,2191.0
101,877.342202846362,2190.612404581761
102,829.7326783896201,2183.7165847987026
103,781.9817929730343,2178.0
104,733.9077152317758,2177.549041804634
105,686.2759500873544,2171.0
106,643.8012066019901,2171.4085092961236
107,691.4111288665652,2178.301391108321
108,739.0731161039507,2184.6175239458576
109,785.2162559609671,2198.1773706609742
110,832.819508423369,2205.1195116450745
111,880.4272327389399,2212.0
112,928.5117969819133,2211.847549835175
113,974.6166530354088,2198.1141884575377
114,1020.7985229507004,2184.6420974727125
115,1068.4598037271553,2178.3175245341054
116,1116.5468224787428,2178.0
117,1164.6536095928532,2178.0
118,1212.3920154280565,2183.7947253737943
119,1259.99918560368,2190.7082145672034
120,1216.397561933918,2184.3496444486964
121,1168.6839007747005,2178.2149660563446
122,1120.5907794455325,2178.0
123,1072.97087626455,2171.287419455247
124,1024.8849365598517,2171.0
125,977.2619544307842,2164.3298683544895
126,929.1790936741718,2164.0
127,953.8097888410819,2124.8073576857646
128,955.0,2077.0572702804857
129,955.0,2028.9504831663753
130,955.0,1980.843696052265
131,961.820389828101,1933.2316126073072
132,962.0,1885.137853166585
133,974.2784062123444,1838.6643462928823
134,975.0,1790.6535459749894
135,981.7035229018983,1743.0329858155544
136,975.3543361140014,1695.4297333531524
137,963.0660299209252,1648.9361104772622
138,955.5140493802315,1601.451474410126
139,948.5614243730126,1553.8497671292296
140,941.6192833889123,1506.2465146668278
141,935.5653742037487,1458.522993629989
142,928.7156376215142,1410.9072294046696
143,921.6438634045478,1363.3230828591065
144,921.0,1315.2639800371362
145,964.3839035850593,1304.6731807271788
146,1011.9679198523835,1310.399477424823
147,1060.030232480587,1311.0
148,1107.6750365747891,1317.3692761671568
149,1155.2782890371911,1311.688582848743
150,1202.8815414995931,1304.7464418646427
151,1250.9341869094087,1304.0
152,1299.0409740235182,1304.0
153,1347.1477611376285,1304.0
154,1394.7913350571516,1310.3862363625012
155,1442.3751690041738,1317.4601315538132
156,1489.9767986755166,1324.4132831401796
157,1537.700939168032,1330.462617396004
158,1585.7742700512426,1331.0
159,1633.881057165352,1331.0
160,1662.1928995270218,1367.7373659484406
161,1671.2056120866093,1414.552768593893
162,1677.2841198657534,1462.2729589260275
163,1678.0,1510.335176954928
164,1678.0,1558.4419640690385
165,1678.0,1606.5487511831489
166,1672.5851968939505,1654.318424848396
167,1665.738700119651,1701.9346277509642
168,1665.0,1749.9878346931482
169,1665.0,1798.0946218072586
170,1658.6214320091642,1845.7387519371591
171,1658.0,1893.8004646929385
172,1658.0,1941.907251807048
173,1658.0,1990.0140389211592
174,1658.0,2038.1208260352687
175,1658.0,2086.22761314938
176,1651.4579335487056,2133.859884237447
177,1639.021367238839,2180.3073645980435
178,1631.6107398977495,2227.812069272575
179,1637.3314010863508,2188.584678265023
180,1649.589459054537,2142.099648033597
181,1651.0,2094.18434091547
182,1657.194004853964,2046.5268238585313
183,1658.0,1998.4784980297882
184,1658.0,1950.3717109156787
185,1658.0,1902.2649238015674
186,1664.3266830811085,1854.6170303009708
187,1671.268824065209,1807.0137778385672
188,1677.4502332219895,1759.3065064277482
189,1678.0,1711.2346689921342
190,1678.0,1663.127881878023
191,1684.3464591753157,1615.4814227978352
192,1685.0,1567.4220389923412
193,1691.435257170923,1519.7918447095171
194,1698.3889160696517,1472.1902898081028
195,1699.0,1424.127826474616
196,1711.3141089790581,1377.7801977860863
197,1706.8002936569505,1330.3734002680972
198,1747.1901834990344,1336.155674697655
199,1791.4805025888834,1354.7466075397138
200,1838.3893021520028,1363.6736627690004
201,1885.1125108583537,1355.2195283091958
202,1932.4164091374596,1346.835107000787
203,1980.0039907552643,1339.786639674748
204,2027.6018727558264,1332.8080602231087
205,2075.577515749297,1331.0
206,2123.4087442773107,1326.5739069653362
207,2171.0468273893493,1319.8890043390531
208,2219.0165992592993,1318.0
209,2266.74528220418,1312.7871463452236
210,2314.722442144979,1311.0
211,2362.8292292590904,1311.0
212,2410.9360163732,1311.0
213,2458.6550757617406,1316.3455318819206
214,2506.2583282241426,1323.2876728660208
215,2553.9610582165797,1329.4951322770723
216,2601.9741556547724,1331.0
217,2650.080942768882,1331.0
218,2666.3664457598056,1367.7984852100947
219,2673.308586743906,1415.4017376724967
220,2675.0,1463.3858414261358
221,2675.0,1511.4926285402453
222,2680.4258548543926,1559.2058618586932
223,2682.0,1607.198471425927
224,2682.0,1655.3052585400364
225,2682.0,1703.4120456541477
226,2682.0,1751.5188327682572
227,2682.0,1799.6256198823685
228,2676.4106466851485,1847.3269941589815
229,2680.531494298952,1894.9302466213853
230,2682.0,1942.9305185396206
231,2682.0,1991.03730565373
232,2687.648762409439,2038.73437080758
233,2693.8054961462362,2086.44396916989
234,2700.552408176837,2134.073656069739
235,2707.6089434091045,2181.6600486039883
236,2724.497185073638,2226.4221373111727
237,2748.9074955506376,2267.7113821324497
238,2769.8434193735825,2310.8242064965984
239,2788.824026333666,2355.0263459055227
240,2821.099731778693,2365.893867346822
241,2854.0491371285425,2335.6820708914975
242,2870.862963375014,2290.6743372410247
243,2884.208928081023,2244.4593424700693
244,2897.0538544197084,2198.1010705610006
245,2911.8403225434877,2152.38322589563
246,2928.2542615044313,2107.3993496838984
247,2937.3821011261975,2060.4305355747006
248,2955.7098914833246,2016.1321726857732
249,2963.1811728049433,1968.6387465663624
250,2975.810850251954,1922.2199419933004
251,2989.286241912528,1876.0390450079415
252,3003.017951046302,1829.9337192136534
253,3015.5938096854984,1783.4997796227751
254,3029.0348332340345,1737.3091431975963
255,3041.6747531774745,1690.8932190370172
256,3060.2501536024315,1646.5710774801562
257,3075.0625952883365,1600.861287246299
258,3092.5451193557606,1556.0917135461748
259,3111.597417180706,1511.9201893012435
260,3126.7478676740093,1466.392488588274
261,3143.4287088755855,1421.4214610879749
262,3159.4423996962564,1376.212678044592
263,3166.0,1375.0218135276227
264,3162.5928957008464,1422.8762717228888
265,3152.800016933046,1469.892245170291
266,3139.813542701647,1516.2107107372105
267,3120.8894879018785,1559.8715183712213
268,3094.431208659427,1600.0489053690185
269,3067.7182178284947,1640.055466751133
270,3043.5810112348427,1681.4055730363773
271,3022.9622338270333,1724.6869782626532
272,2993.135634739548,1761.4960454154193
273,2951.2870878965946,1783.5622996817467
274,2903.6552191113524,1790.293097611081
275,2855.9478026344354,1796.4659454491448
276,2808.3445501720316,1800.5919135667546
277,2760.7186845995957,1793.8151512254803
278,2713.0235338740295,1787.5450986899625
279,2683.936354146577,1785.723480894407
280,2728.2843459979536,1804.3610907650432
281,2772.4164738487434,1823.0
282,2820.523260962853,1823.0
283,2868.524846153884,1822.2635865384505
284,2914.680155560991,1808.716601849587
285,2959.0864205894,1790.2139914210834
286,2993.7847393174943,1757.215260682506
287,3020.7352403509954,1717.4390794670066
288,3039.9188352662673,1673.3947953609581
289,3065.612470140395,1632.8888830087071
290,3092.2042151833894,1592.801006573372
291,3103.4214390918223,1546.8244176560752
292,3115.407004054282,1500.3188432424615
293,3128.4037320977645,1454.001891646544
294,3136.995429073292,1406.74562921171
295,3152.159907792801,1361.4162212972778
296,3188.109645480376,1336.5096867348902
297,3230.743351871851,1315.3641341331715
298,3274.3465959383157,1296.3155761846579
299,3321.353848691906,1286.8307689135117
300,3369.0197462295273,1280.3512870081938
301,3416.883454279079,1277.0
302,3464.9902413931904,1277.0
303,3513.0970285073,1277.0
304,3560.929539787086,1273.2186087810499
305,3608.8028713929816,1270.0
306,3656.627994601917,1273.8832492127797
307,3704.231247064321,1280.82539019688
308,3750.0994800463695,1294.0414500193206
309,3792.5529509185367,1316.2177969463535
310,3832.5314191107655,1342.9726764658885
311,3869.92124551243,1372.9212455124298
312,3900.8409412256246,1409.4621700092819
313,3924.5058042230844,1451.1561239384787
314,3941.8495602117746,1495.9176407656464
315,3954.859033292621,1542.2309712889867
316,3965.0,1588.8890488734723
317,3966.731081821166,1636.8702753451382
318,3970.291941385786,1684.4683935525804
319,3958.2993211288986,1730.1751049524132
320,3928.7524347881636,1767.3154103885713
321,3888.935324181115,1794.310884075851
322,3847.6754994733756,1818.4279793202654
323,3801.4575587537024,1831.7719111708723
324,3754.898302503981,1843.7439975515026
325,3707.245282321601,1850.0
326,3659.1384952074895,1850.0
327,3611.03170809338,1850.0
328,3562.924920979269,1850.0
329,3515.065408510553,1851.7309225177553
330,3468.8665483077457,1865.1432951489214
331,3422.6737084783904,1878.4552525407041
332,3378.6003226052203,1897.737358860216
333,3351.902108388536,1937.6301317062976
334,3356.7634676750445,1985.107741400354
335,3370.1889619320095,2031.2772293431742
336,3395.895757796384,2071.804669246361
337,3415.7485892861355,2115.5682040825955
338,3440.9967991959356,2156.4025469271614
339,3467.4550784383873,2196.5799339249584
340,3494.4446070134563,2236.4010316982753
341,3521.0652836431373,2276.4695047914306
342,3553.1008734958527,2312.1008734958527
343,3587.1175088853365,2346.1175088853365
344,3621.1341442748208,2380.1341442748208
345,3662.586409692319,2403.25655424039
346,3709.2826132299124,2410.0
347,3756.133824330261,2401.210967903674
348,3744.8125496945536,2400.2565031695444
349,3697.2092972321516,2407.1986441536446
350,3649.606044769746,2405.8592148622547
351,3606.3702144257063,2387.438921694977
352,3569.9719040544105,2356.412254173658
353,3536.1770391122277,2322.1770391122277
354,3506.346484347691,2284.7483651205675
355,3483.5329723706827,2242.573795305814
356,3460.7424232865983,2200.3866427685384
357,3437.806953256438,2158.3366878154516
358,3416.1821560137523,2115.623871305852
359,3393.8521913824434,2073.6850143351753
360,3382.944456611997,2026.9048453394078
361,3374.048060466737,1979.7327744240451
362,3371.280346150446,1935.3394931368473
363,3402.3784565151072,1900.3628173017607
364,3446.9122564462727,1882.8461292682518
365,3494.5363564075574,1876.0579554490553
366,3542.2515417084333,1869.9424835008535
367,3589.927302375985,1864.0
368,3637.9499965232626,1862.8406255070242
369,3685.5532489856682,1855.8984845229234
370,3733.1565014480702,1848.9563435388231
371,3780.3057755121317,1840.3725935366117
372,3824.4069393622653,1821.3151424464143
373,3864.1414595008205,1794.4200213851943
374,3910.421526609163,1781.578473390837
375,3944.438161998647,1747.5618380013532
376,3978.3627292093674,1713.4688608005688
377,4005.4931120615906,1673.7422287669567
378,3992.781763216243,1627.6803310271177
379,3979.311862824291,1581.4978153975692
380,3972.6142179898916,1533.9137439191343
381,3965.6428096816203,1486.3160078623087
382,3952.7519115605596,1440.0065539219183
383,3921.4076094123375,1404.4076094123377
384,3887.823154331466,1369.9650118118032
385,3844.983278500348,1349.159699375145
386,3799.2000940108173,1334.558360753155
387,3757.43632452918,1311.531238104582
388,3714.334357701648,1290.5252585964458
389,3667.8872939106395,1279.4627303619682
390,3620.2840414482375,1272.520589377868
391,3572.360080366816,1270.0
392,3524.2532932527065,1270.0
393,3476.1465061385934,1270.0
394,3428.374247890677,1274.6120888492762
395,3380.4406632529135,1277.0
396,3332.6653260569115,1281.5696399500337
397,3287.231200027146,1296.24204254164
398,3241.00255401044,1308.0829608734775
399,3194.0,1318.0

"""

# --- Main Execution ---
if __name__ == "__main__":
    # 1. Parse the coordinates from the data string
    coordinates = parse_coordinates(data_text)
    
    if not coordinates:
        print("No valid coordinates were parsed. Please check the data_text format.")
    else:
        # 2. Process the coordinates (apply FFT filter)
        x_filtered, y_filtered = process_coordinates(coordinates)
        
        # 3. Scale the filtered coordinates for the 12-bit DAC
        x_dac, y_dac = scale_for_dac(x_filtered, y_filtered)
        
        # 4. Generate the C header file
        generate_stm32_header(x_dac, y_dac, filename="drawing_coordinates_data.h")
        
        # --- Output Summary ---
        print("Processing complete!")
        print("Generated 'drawing_coordinates_data.h' for STM32.")
        print(f"Original points parsed: {len(coordinates)}")
        print(f"Filtered points generated: {len(x_filtered)}")
        print(f"DAC range: X=[{min(x_dac)}, {max(x_dac)}], Y=[{min(y_dac)}, {max(y_dac)}]")
